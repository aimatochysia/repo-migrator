name: Recommit Source Repo History to Target Repo

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: "Source repository (owner/name), e.g. octocat/hello-world"
        required: true
        type: string
      target_repo:
        description: "Target repository (owner/name), e.g. my-org/rewritten-history"
        required: true
        type: string
      author_name:
        description: "New author name for all commits, e.g. John Doe"
        required: true
        type: string
      author_email:
        description: "New author email for all commits, e.g. john.doe@example.com"
        required: true
        type: string

jobs:
  recommit:
    runs-on: ubuntu-latest
    env:
      PAT: ${{ secrets.PAT }}
    steps:
      - name: Validate PAT
        run: |
          if [ -z "$PAT" ]; then
            echo "PAT is not set" >&2
            exit 1
          fi

      - name: Clone source repository
        run: |
          set -e
          mkdir -p "$GITHUB_WORKSPACE/work"
          echo "Cloning source repo ${{ inputs.source_repo }}"
          git clone https://x-access-token:${PAT}@github.com/${{ inputs.source_repo }}.git \
            "$GITHUB_WORKSPACE/work/source"
          cd "$GITHUB_WORKSPACE/work/source"
          git checkout main

      - name: Prepare target repository
        run: |
          set -e
          echo "Cloning target repo ${{ inputs.target_repo }}"
          git clone https://x-access-token:${PAT}@github.com/${{ inputs.target_repo }}.git \
            "$GITHUB_WORKSPACE/work/target"
          cd "$GITHUB_WORKSPACE/work/target"
          
          echo "Cleaning target repository completely"
          # Create a fresh orphan branch (no history)
          git checkout --orphan temp-branch
          
          # Remove all files from git tracking
          git rm -rf . 2>/dev/null || true
          
          # Also remove any untracked files
          git clean -fdx
          
          # Rename temp branch to main (will delete old main if it exists)
          git branch -M temp-branch main
          
          echo "Adding source repo as remote"
          git remote add source "$GITHUB_WORKSPACE/work/source"
          git fetch source

      - name: Recommit history with author rewrite and Copilot squash
        run: |
          set -euo pipefail

          SRC_DIR="$GITHUB_WORKSPACE/work/source"
          TGT_DIR="$GITHUB_WORKSPACE/work/target"

          NEW_AUTHOR_NAME="${{ inputs.author_name }}"
          NEW_AUTHOR_EMAIL="${{ inputs.author_email }}"

          # Ensure committer identity is always set
          export GIT_COMMITTER_NAME="$NEW_AUTHOR_NAME"
          export GIT_COMMITTER_EMAIL="$NEW_AUTHOR_EMAIL"

          echo "Starting history rewrite"

          cd "$SRC_DIR"
          COMMITS=$(git rev-list --reverse main)

          cd "$TGT_DIR"

          CURRENT_SQUASH_MSG=""
          CURRENT_SQUASH_DATE=""
          SQUASHING=false

          for COMMIT in $COMMITS; do
            cd "$SRC_DIR"
            AUTHOR_NAME=$(git show -s --format='%an' $COMMIT)
            AUTHOR_EMAIL=$(git show -s --format='%ae' $COMMIT)
            AUTHOR_DATE=$(git show -s --format='%aI' $COMMIT)
            COMMIT_MSG=$(git show -s --format='%B' $COMMIT)

            # Check if this is a merge commit (has more than one parent)
            PARENT_COUNT=$(git rev-list --parents -n 1 $COMMIT | awk '{print NF-1}')

            cd "$TGT_DIR"

            echo "Processing commit $COMMIT"
            echo "  Original author: $AUTHOR_NAME <$AUTHOR_EMAIL>"
            echo "  Date: $AUTHOR_DATE"

            # Skip merge commits - their changes are already in the history via their parents
            if [ "$PARENT_COUNT" -gt 1 ]; then
              echo "  -> Skipping merge commit (changes already in history via parents)"
              continue
            fi

            IS_COPILOT=false
            if echo "$AUTHOR_NAME $AUTHOR_EMAIL" | grep -qi "copilot"; then
              IS_COPILOT=true
            fi

            if [ "$IS_COPILOT" = true ]; then
              echo "  -> Identified as Copilot commit, squashing"
              SQUASHING=true
              CURRENT_SQUASH_MSG="${CURRENT_SQUASH_MSG}\n--- Squashed commit $COMMIT ---\n$COMMIT_MSG\n"
              if [ -z "$CURRENT_SQUASH_DATE" ]; then
                CURRENT_SQUASH_DATE="$AUTHOR_DATE"
              fi
              
              # Apply this Copilot commit's changes to working tree without committing
              echo "  -> Applying changes from $COMMIT to working tree"
              if ! git cherry-pick --no-commit "$COMMIT" >/dev/null 2>&1; then
                echo "  -> Cherry-pick had conflicts, resolving with theirs strategy"
                # Accept all changes from the commit being cherry-picked
                git checkout --theirs . 2>/dev/null || true
                git add -A
              fi
              continue
            fi

            if [ "$SQUASHING" = true ]; then
              echo "Committing squashed Copilot commits"
              git add -A || true
              GIT_AUTHOR_NAME="$NEW_AUTHOR_NAME" \
              GIT_AUTHOR_EMAIL="$NEW_AUTHOR_EMAIL" \
              GIT_AUTHOR_DATE="$CURRENT_SQUASH_DATE" \
              GIT_COMMITTER_DATE="$CURRENT_SQUASH_DATE" \
              git commit --allow-empty -m "Squashed Copilot commits$CURRENT_SQUASH_MSG"

              CURRENT_SQUASH_MSG=""
              CURRENT_SQUASH_DATE=""
              SQUASHING=false
            fi

            echo "Cherry-picking commit $COMMIT"
            if ! git cherry-pick --no-commit "$COMMIT" >/dev/null 2>&1; then
              echo "  -> Cherry-pick had conflicts, resolving with theirs strategy"
              # Accept all changes from the commit being cherry-picked
              git checkout --theirs . 2>/dev/null || true
              git add -A
            fi

            git add -A
            GIT_AUTHOR_NAME="$NEW_AUTHOR_NAME" \
            GIT_AUTHOR_EMAIL="$NEW_AUTHOR_EMAIL" \
            GIT_AUTHOR_DATE="$AUTHOR_DATE" \
            GIT_COMMITTER_DATE="$AUTHOR_DATE" \
            git commit -m "$COMMIT_MSG"

            echo "  -> Commit created for $COMMIT"
          done

          if [ "$SQUASHING" = true ]; then
            echo "Finalizing trailing Copilot squash"
            git add -A || true
            GIT_AUTHOR_NAME="$NEW_AUTHOR_NAME" \
            GIT_AUTHOR_EMAIL="$NEW_AUTHOR_EMAIL" \
            GIT_AUTHOR_DATE="$CURRENT_SQUASH_DATE" \
            GIT_COMMITTER_DATE="$CURRENT_SQUASH_DATE" \
            git commit --allow-empty -m "Squashed Copilot commits$CURRENT_SQUASH_MSG"
          fi

      - name: Push rewritten history to target
        run: |
          set -e
          cd "$GITHUB_WORKSPACE/work/target"
          echo "Pushing rewritten history to target repo"
          git branch -M main
          git push -f https://x-access-token:${PAT}@github.com/${{ inputs.target_repo }}.git main
          echo "Push completed"
